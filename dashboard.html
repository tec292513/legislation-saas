<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600&family=Inter:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>

    <header class="top-nav">
        <div class="container">
            <div class="logo">YourLogo</div>
            <nav>
                <a href="#" id="logout-button" class="nav-link">Log Out</a>
            </nav>
        </div>
    </header>

    <main class="dashboard-container">
        <div class="sidebar">
            <h2>Filters</h2>
            <div class="filter-group">
                <h3>Jurisdiction</h3>
                <button class="filter-button active" data-filter="jurisdiction" data-value="all">All</button>
                <button class="filter-button" data-filter="jurisdiction" data-value="Federal">Federal</button>
                <button class="filter-button" data-filter="jurisdiction" data-value="California">California</button>
            </div>
            <div class="filter-group">
                <h3>Category</h3>
                <button class="filter-button active" data-filter="category" data-value="all">All</button>
                <button class="filter-button" data-filter="category" data-value="Taxes">Taxes</button>
                <button class="filter-button" data-filter="category" data-value="Family">Family</button>
            </div>
        </div>
        <div class="main-content">
            <h2>Your Briefing</h2>
            <p>Loading laws...</p>
        </div>
    </main>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        const supabaseUrl = 'https://jodfjkhdwlzurkylnayl.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpvZGZqa2hkd2x6dXJreWxuYXlsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTcyMTAwMDYsImV4cCI6MjA3Mjc4NjAwNn0.51MRmokELdbOYDq6ffZcIAWgqYo_crZwDctPK6M4UDU';
        const supaClient = supabase.createClient(supabaseUrl, supabaseKey);

        const mainContent = document.querySelector('.main-content');
        const logoutButton = document.querySelector('#logout-button');
        
        let userProfile = null;
        let allLaws = [];
        let currentFilters = {
            jurisdiction: 'all',
            category: 'all'
        };

        // --- NEW: This runs when the page loads and waits for the login to be confirmed ---
        supaClient.auth.onAuthStateChange((event, session) => {
            if (session) {
                // If the user IS logged in, run the main function to get their laws
                initializeDashboard(session.user);
            } else {
                // If the user is NOT logged in, send them back to the homepage
                window.location.href = '/';
            }
        });

        // --- Log-Out Logic ---
        logoutButton.addEventListener('click', async (event) => {
            event.preventDefault();
            const { error } = await supaClient.auth.signOut();
        });

        // --- Main Function to Fetch and Display Laws ---
        async function initializeDashboard(user) {
            // 1. Fetch user profile
            const { data: profileData, error: profileError } = await supaClient.from('profiles').select('*').eq('id', user.id).single();
            if (profileError) { return console.error('Error fetching profile:', profileError); }
            userProfile = profileData;

            // 2. Fetch all laws ONCE
            const { data: lawsData, error: lawsError } = await supaClient.from('laws').select('*');
            if (lawsError) { return console.error('Error fetching laws:', lawsError); }
            allLaws = lawsData;

            // 3. Initial display
            displayFilteredLaws();
        }

        // --- Function to Display Laws Based on Filters ---
        function displayFilteredLaws() {
            const matchingLaws = allLaws.filter(law => {
                let isMatch = true;
                if (law.applies_to_family_status && law.applies_to_family_status !== userProfile.family_status) { isMatch = false; }
                if (law.applies_to_home_status && law.applies_to_home_status !== userProfile.home_status) { isMatch = false; }
                if (law.applies_to_work_status && law.applies_to_work_status !== userProfile.work_status) { isMatch = false; }
                if (!law.applies_to_family_status && !law.applies_to_home_status && !law.applies_to_work_status) { isMatch = false; }
                return isMatch;
            });

            const filteredLaws = matchingLaws.filter(law => {
                const jurisdictionMatch = currentFilters.jurisdiction === 'all' || law.jurisdiction === currentFilters.jurisdiction;
                const categoryMatch = currentFilters.category === 'all' || law.category === currentFilters.category;
                return jurisdictionMatch && categoryMatch;
            });

            mainContent.innerHTML = '<h2>Your Briefing</h2>';
            if (filteredLaws.length ===.0) {
                mainContent.innerHTML += '<p>No new laws match your profile and selected filters.</p>';
            }
            for (const law of filteredLaws) {
                const lawCard = `
                    <div class="law-card">
                        <h3>${law.title}</h3>
                        <div class="badges">
                            <span class="badge jurisdiction">${law.jurisdiction}</span>
                            <span class="badge status">${law.status}</span>
                        </div>
                        <p>${law.summary}</p>
                    </div>`;
                mainContent.innerHTML += lawCard;
            }
        }

        // --- Logic to Handle Filter Button Clicks ---
        const filterButtons = document.querySelectorAll('.filter-button');
        filterButtons.forEach(button => {
            button.addEventListener('click', () => {
                const filterGroup = button.dataset.filter;
                const filterValue = button.dataset.value;
                currentFilters[filterGroup] = filterValue;
                document.querySelectorAll(`[data-filter="${filterGroup}"]`).forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                displayFilteredLaws();
            });
        });
    </script>

</body>
</html>